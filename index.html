<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADAM & EVE MOTORS - Dynamic Dashboard</title>
    <style>
        /* --- General Styling & Theming --- */
        :root {
            --bg-color: #1a1a2e;
            --sidebar-color: #16213e;
            --primary-color: #0f3460;
            --accent-color: #e94560;
            --text-color: #e0e0e0;
            --text-muted-color: #a0a0c0;
            --card-bg-color: #1f2847;
            --border-color: #2a365f;
            --success-color: #4CAF50;
            --error-color: #F44336;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .hidden { display: none !important; }

        /* --- Login Screen --- */
        #login-screen {
            background-color: var(--card-bg-color);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        #login-screen h1 {
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        #login-screen h2 {
            margin-bottom: 30px;
            font-weight: 300;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-color);
            font-size: 16px;
        }

        .login-button {
            width: 100%;
            padding: 15px;
            background: var(--accent-color);
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-button:hover {
            background: #d83c54;
        }
        
        #login-error {
            color: var(--error-color);
            margin-top: 15px;
            font-size: 14px;
        }
        
        .public-access-btn {
            margin-top: 20px;
            background: none;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .public-access-btn:hover {
            background: var(--accent-color);
            color: white;
        }


        /* --- Main App Layout --- */
        #app-container {
            display: flex;
            width: 100vw;
            height: 100vh;
            background-color: var(--bg-color);
        }

        .sidebar {
            width: 260px;
            background-color: var(--sidebar-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.3s;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .sidebar-header h2 {
            color: var(--accent-color);
            font-size: 24px;
        }
        .sidebar-header p {
            font-size: 12px;
            color: var(--text-muted-color);
        }

        .sidebar-nav a {
            display: block;
            padding: 15px 20px;
            color: var(--text-muted-color);
            text-decoration: none;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: all 0.3s;
        }
        
        .sidebar-nav a.active, .sidebar-nav a:hover {
            background-color: var(--primary-color);
            color: var(--text-color);
        }

        .sidebar-footer {
            margin-top: auto;
        }

        .logout-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            border: none;
            color: white;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }

        /* --- Main Content Area --- */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .content-header h1 {
            color: var(--text-color);
        }
        
        .action-button {
            padding: 10px 20px;
            background: var(--accent-color);
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .action-button:hover {
            background: #d83c54;
        }

        /* --- Cards and Grids --- */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .card {
            background-color: var(--card-bg-color);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        .card h3 {
            margin-bottom: 10px;
            color: var(--text-muted-color);
            font-weight: 500;
        }
        
        .card .value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-color);
        }

        /* --- Tables --- */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--card-bg-color);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .data-table th, .data-table td {
            padding: 15px;
            text-align: left;
        }
        
        .data-table thead {
            background-color: var(--primary-color);
        }
        
        .data-table tbody tr {
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table tbody tr:last-child {
            border-bottom: none;
        }

        .data-table .actions button {
            background: none;
            border: none;
            color: var(--text-muted-color);
            cursor: pointer;
            font-size: 16px;
            margin: 0 5px;
        }
        .data-table .actions .edit-btn:hover { color: var(--success-color); }
        .data-table .actions .delete-btn:hover { color: var(--error-color); }


        /* --- Forms & Modals --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--card-bg-color);
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-muted-color);
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-muted-color);
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-color);
        }

        /* --- Ticketing Specific Styles --- */
        #active-trip-notification {
            background-color: var(--success-color);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        #active-trip-notification.no-trip {
            background-color: var(--error-color);
        }

        #generated-ticket-modal .ticket-details {
            background-color: #fff;
            color: #333;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', Courier, monospace;
            border: 2px dashed #ccc;
        }
        #generated-ticket-modal h3 { color: var(--primary-color); }
        #generated-ticket-modal p { line-height: 1.6; }
        #generated-ticket-modal .ticket-id {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-color);
            text-align: center;
            margin: 10px 0;
        }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -260px;
                height: 100%;
                z-index: 100;
                transition: left 0.3s;
            }
            .sidebar.open {
                left: 0;
            }
            .main-content {
                padding: 20px;
            }
            .content-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .content-header h1 {
                margin-bottom: 15px;
            }
            .menu-toggle {
                display: block; /* Show hamburger menu on small screens */
                position: fixed;
                top: 15px;
                left: 15px;
                z-index: 101;
                background: var(--accent-color);
                color: white;
                border: none;
                padding: 10px;
                border-radius: 5px;
            }
        }
        
        .menu-toggle { display: none; }
    </style>
</head>
<body>

    <!-- ======== LOGIN SCREEN ======== -->
    <div id="login-screen">
        <h1>ADAM & EVE MOTORS</h1>
        <h2>Admin & Staff Portal</h2>
        <form id="login-form">
            <input type="text" id="username" class="login-input" placeholder="Username" required>
            <input type="password" id="password" class="login-input" placeholder="Password" required>
            <button type="submit" class="login-button">Login as Admin</button>
            <div id="login-error" class="hidden">Invalid credentials. Please try again.</div>
        </form>
        <button id="public-access-btn" class="public-access-btn">Access Public Ticketing</button>
    </div>

    <!-- ======== MAIN APPLICATION ======== -->
    <div id="app-container" class="hidden">
        <button class="menu-toggle" id="menu-toggle">☰</button>
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>ADAM & EVE MOTORS</h2>
                <p>Transport Management System</p>
            </div>
            <div class="sidebar-nav">
                <a href="#" class="nav-link active" data-section="dashboard">📊 Dashboard</a>
                <a href="#" class="nav-link" data-section="ticketing">🚍 Ticketing Portal</a>
                <div class="admin-only">
                    <a href="#" class="nav-link" data-section="vehicle-management">🚍 Vehicle & Driver Mgmt</a>
                    <a href="#" class="nav-link" data-section="staff-management">👥 Staff & Salaries</a>
                    <a href="#" class="nav-link" data-section="settings">⚙️ Settings</a>
                </div>
            </div>
            <div class="sidebar-footer">
                 <button id="logout-btn" class="logout-btn admin-only">Logout</button>
                 <button id="back-to-login-btn" class="logout-btn public-only">Back to Login</button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Section: Dashboard -->
            <section id="dashboard" class="content-section active">
                <div class="content-header">
                    <h1>Dashboard Overview</h1>
                </div>
                <div class="card-grid">
                    <div class="card"><h3>Total Vehicles</h3><p class="value" id="total-vehicles-stat">0</p></div>
                    <div class="card"><h3>Active Drivers</h3><p class="value" id="total-drivers-stat">0</p></div>
                    <div class="card"><h3>Tickets Sold Today</h3><p class="value" id="tickets-today-stat">0</p></div>
                    <div class="card"><h3>Today's Revenue</h3><p class="value" id="revenue-today-stat">₦0</p></div>
                    <div class="card"><h3>Open Complaints</h3><p class="value" id="open-complaints-stat">0</p></div>
                    <div class="card"><h3>Buses on Maintenance</h3><p class="value" id="maintenance-stat">0</p></div>
                </div>
            </section>

            <!-- Section: Ticketing Portal -->
            <section id="ticketing" class="content-section">
                <div class="content-header"><h1>Passenger Ticketing</h1></div>
                
                <div id="driver-trip-setup" class="admin-only">
                    <h2>Driver: Set Up Your Trip</h2>
                    <div class="card">
                        <form id="trip-setup-form">
                             <div class="form-group"><label>Select Your Bus</label><select id="trip-bus-plate" required></select></div>
                             <div class="form-group"><label>Your Name</label><input type="text" id="trip-driver-name" placeholder="Enter your name" required></div>
                             <div class="form-group"><label>Your Phone</label><input type="tel" id="trip-driver-phone" placeholder="Enter your phone number" required></div>
                             <div class="form-group"><label>Destination</label><select id="trip-destination" required></select></div>
                             <button type="submit" class="action-button">Start Trip & Enable Ticketing</button>
                        </form>
                    </div>
                </div>

                <div id="active-trip-notification" class="no-trip">No active trip. Ticketing is disabled.</div>
                
                <div id="ticket-purchase-section" class="card hidden">
                    <h2>Purchase a Ticket</h2>
                    <form id="ticket-purchase-form">
                        <div class="form-group">
                            <label for="ticket-destination">Destination</label>
                            <input type="text" id="ticket-destination-display" readonly>
                        </div>
                        <div class="form-group">
                            <label for="ticket-price">Price (NGN)</label>
                            <input type="text" id="ticket-price-display" readonly>
                        </div>
                         <div class="form-group">
                            <label for="passenger-name">Passenger Name</label>
                            <input type="text" id="passenger-name" required>
                        </div>
                        <button type="submit" class="action-button">Generate Ticket</button>
                    </form>
                </div>
            </section>

            <!-- Section: Vehicle & Driver Management -->
            <section id="vehicle-management" class="content-section">
                <div class="content-header">
                    <h1>Vehicle & Driver Management</h1>
                    <button class="action-button" id="add-vehicle-btn">Add New Vehicle</button>
                    <button class="action-button" id="add-driver-btn">Add New Driver</button>
                </div>
                <h2>Registered Vehicles</h2>
                <table class="data-table">
                    <thead><tr><th>Plate No.</th><th>Brand</th><th>Capacity</th><th>Purchase Date</th><th>Insurance</th><th>Actions</th></tr></thead>
                    <tbody id="vehicles-table"></tbody>
                </table>
                <h2 style="margin-top: 30px;">Registered Drivers</h2>
                <table class="data-table">
                    <thead><tr><th>Name</th><th>License No.</th><th>Health Status</th><th>Contact</th><th>Assigned Bus</th><th>Actions</th></tr></thead>
                    <tbody id="drivers-table"></tbody>
                </table>
            </section>
            
            <!-- Section: Staff & Salaries Management -->
            <section id="staff-management" class="content-section">
                <div class="content-header">
                    <h1>Staff & Salaries</h1>
                    <button class="action-button" id="add-staff-btn">Add New Staff</button>
                </div>
                <table class="data-table">
                    <thead><tr><th>Staff ID</th><th>Name</th><th>Role</th><th>Branch</th><th>Salary (₦)</th><th>Actions</th></tr></thead>
                    <tbody id="staff-table"></tbody>
                </table>
            </section>

             <!-- Section: Settings (for prices) -->
            <section id="settings" class="content-section">
                <div class="content-header"><h1>System Settings</h1></div>
                <h2>Destination Prices (Admin Editable)</h2>
                 <div class="card">
                     <form id="prices-form">
                        <div id="prices-container" class="card-grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                            <!-- Prices will be injected here by JS -->
                        </div>
                        <button type="submit" class="action-button" style="margin-top: 20px;">Save Price Changes</button>
                     </form>
                 </div>
            </section>

            <!-- Placeholder sections for other features -->
            <section id="waybill-management" class="content-section"><h1>🧾 Waybill Management (Coming Soon)</h1></section>
            <section id="asset-inventory" class="content-section"><h1>🗃️ Asset Inventory (Coming Soon)</h1></section>
            <section id="branch-monitoring" class="content-section"><h1>📍 Branch Monitoring (Coming Soon)</h1></section>
            <section id="complaints" class="content-section"><h1>📞 Complaint Management (Coming Soon)</h1></section>
            <section id="accounting" class="content-section"><h1>💰 Accounting (Coming Soon)</h1></section>
            <section id="reports" class="content-section"><h1>📈 Reporting & Analytics (Coming Soon)</h1></section>

        </main>
    </div>

    <!-- ======== MODALS ======== -->
    <!-- Add/Edit Vehicle Modal -->
    <div id="vehicle-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2 id="vehicle-modal-title">Add New Vehicle</h2>
            <form id="vehicle-form">
                <input type="hidden" id="vehicle-id">
                <div class="form-group"><label>Plate Number</label><input type="text" id="vehicle-plate" required></div>
                <div class="form-group"><label>Brand</label><input type="text" id="vehicle-brand" required></div>
                <div class="form-group"><label>Capacity</label><input type="number" id="vehicle-capacity" required></div>
                <div class="form-group"><label>Purchase Date</label><input type="date" id="vehicle-purchase-date" required></div>
                <div class="form-group"><label>Insurance Status</label><select id="vehicle-insurance"><option value="Active">Active</option><option value="Expired">Expired</option></select></div>
                <button type="submit" class="action-button">Save Vehicle</button>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit Driver Modal -->
    <div id="driver-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2 id="driver-modal-title">Add New Driver</h2>
            <form id="driver-form">
                <input type="hidden" id="driver-id">
                <div class="form-group"><label>Full Name</label><input type="text" id="driver-name" required></div>
                <div class="form-group"><label>License Number</label><input type="text" id="driver-license" required></div>
                <div class="form-group"><label>Health Status</label><select id="driver-health"><option value="Fit">Fit</option><option value="On-Leave">On Leave</option><option value="Requires Checkup">Requires Checkup</option></select></div>
                <div class="form-group"><label>Contact</label><input type="tel" id="driver-contact" required></div>
                <div class="form-group"><label>Assign Bus</label><select id="driver-bus-assignment"></select></div>
                <button type="submit" class="action-button">Save Driver</button>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit Staff Modal -->
    <div id="staff-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2 id="staff-modal-title">Add New Staff</h2>
            <form id="staff-form">
                <input type="hidden" id="staff-id">
                <div class="form-group"><label>Full Name</label><input type="text" id="staff-name" required></div>
                <div class="form-group"><label>Role</label><input type="text" id="staff-role" required></div>
                <div class="form-group"><label>Branch</label><input type="text" id="staff-branch" value="Main" required></div>
                <div class="form-group"><label>Salary (NGN)</label><input type="number" id="staff-salary" required></div>
                <button type="submit" class="action-button">Save Staff</button>
            </form>
        </div>
    </div>

    <!-- Generated Ticket Modal -->
    <div id="generated-ticket-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2>Ticket Generated Successfully!</h2>
            <div class="ticket-details" id="ticket-receipt">
                <!-- Ticket details will be injected here -->
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- STATE MANAGEMENT & DATABASE (using localStorage) ---
    let db = {};
    const NIGERIAN_STATES = [
        "Abia", "Adamawa", "Akwa Ibom", "Anambra", "Bauchi", "Bayelsa", "Benue", "Borno",
        "Cross River", "Delta", "Ebonyi", "Edo", "Ekiti", "Enugu", "Gombe", "Imo",
        "Jigawa", "Kaduna", "Kano", "Katsina", "Kebbi", "Kogi", "Kwara", "Lagos",
        "Nasarawa", "Niger", "Ogun", "Ondo", "Osun", "Oyo", "Plateau", "Rivers",
        "Sokoto", "Taraba", "Yobe", "Zamfara"
    ];

    function initializeDB() {
        const defaultDB = {
            vehicles: [
                { id: 1, plate: 'LAG-123-XY', brand: 'Toyota Hiace', capacity: 14, purchaseDate: '2022-08-15', insurance: 'Active' },
                { id: 2, plate: 'ABJ-456-YZ', brand: 'Mercedes Sprinter', capacity: 18, purchaseDate: '2021-11-20', insurance: 'Active' }
            ],
            drivers: [
                { id: 1, name: 'John Doe', license: 'DRV12345', health: 'Fit', contact: '08012345678', assignedBus: 'LAG-123-XY' },
                { id: 2, name: 'Jane Smith', license: 'DRV67890', health: 'Fit', contact: '09087654321', assignedBus: 'ABJ-456-YZ' }
            ],
            staff: [
                {id: 1, name: 'Admin User', role: 'System Admin', branch: 'HQ', salary: 500000},
                {id: 2, name: 'Peter Obi', role: 'Manager', branch: 'Lagos', salary: 350000}
            ],
            prices: {}, // Will be populated
            activeTrip: null, // { busPlate, driverName, driverPhone, destination, totalSeats, seatsAvailable }
            tickets: [], // { id, ticketNo, passengerName, destination, price, date }
            userRole: 'public' // or 'admin'
        };
        // Populate default prices
        NIGERIAN_STATES.forEach(state => {
            defaultDB.prices[state] = (state === "Lagos" || state === "Abuja") ? 25000 : 15000;
        });

        db = JSON.parse(localStorage.getItem('adamEveMotorsDB')) || defaultDB;
        saveDB();
    }

    function saveDB() {
        localStorage.setItem('adamEveMotorsDB', JSON.stringify(db));
    }

    // --- DOM ELEMENT SELECTORS ---
    const loginScreen = document.getElementById('login-screen');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const publicAccessBtn = document.getElementById('public-access-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const backToLoginBtn = document.getElementById('back-to-login-btn');
    const navLinks = document.querySelectorAll('.nav-link');
    const contentSections = document.querySelectorAll('.content-section');
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');

    // --- UI & NAVIGATION ---
    function showSection(sectionId) {
        contentSections.forEach(section => section.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');

        navLinks.forEach(link => link.classList.remove('active'));
        document.querySelector(`.nav-link[data-section="${sectionId}"]`).classList.add('active');
        
        // Close sidebar on navigation on mobile
        sidebar.classList.remove('open');
    }
    
    function setupUIForRole(role) {
        db.userRole = role;
        const adminElements = document.querySelectorAll('.admin-only');
        const publicElements = document.querySelectorAll('.public-only');

        if (role === 'admin') {
            adminElements.forEach(el => el.classList.remove('hidden'));
            publicElements.forEach(el => el.classList.add('hidden'));
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            showSection('dashboard');
            renderAll();
        } else { // public
            adminElements.forEach(el => el.classList.add('hidden'));
            publicElements.forEach(el => el.classList.remove('hidden'));
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            showSection('ticketing');
            renderAll();
        }
    }

    // --- AUTHENTICATION ---
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        if (username === 'admin' && password === 'password123') {
            setupUIForRole('admin');
        } else {
            loginError.classList.remove('hidden');
        }
    });

    publicAccessBtn.addEventListener('click', () => setupUIForRole('public'));
    
    function logout() {
        db.userRole = 'public';
        appContainer.classList.add('hidden');
        loginScreen.classList.remove('hidden');
        loginError.classList.add('hidden');
        document.getElementById('login-form').reset();
    }
    
    logoutBtn.addEventListener('click', logout);
    backToLoginBtn.addEventListener('click', logout);


    // --- RENDERING FUNCTIONS ---
    function renderAll() {
        renderDashboardStats();
        renderVehicleTable();
        renderDriverTable();
        renderStaffTable();
        populateSelects();
        renderActiveTrip();
        renderPriceSettings();
    }
    
    function renderDashboardStats() {
        document.getElementById('total-vehicles-stat').textContent = db.vehicles.length;
        document.getElementById('total-drivers-stat').textContent = db.drivers.length;
        const today = new Date().toISOString().split('T')[0];
        const ticketsToday = db.tickets.filter(t => t.date === today);
        document.getElementById('tickets-today-stat').textContent = ticketsToday.length;
        const revenueToday = ticketsToday.reduce((sum, t) => sum + t.price, 0);
        document.getElementById('revenue-today-stat').textContent = `₦${revenueToday.toLocaleString()}`;
        // Placeholders
        document.getElementById('open-complaints-stat').textContent = 0;
        document.getElementById('maintenance-stat').textContent = 0;
    }

    // VEHICLE MANAGEMENT
    const vehicleTable = document.getElementById('vehicles-table');
    function renderVehicleTable() {
        vehicleTable.innerHTML = '';
        db.vehicles.forEach(v => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${v.plate}</td>
                <td>${v.brand}</td>
                <td>${v.capacity}</td>
                <td>${v.purchaseDate}</td>
                <td>${v.insurance}</td>
                <td class="actions">
                    <button class="edit-btn" data-id="${v.id}" data-type="vehicle">✏️</button>
                    <button class="delete-btn" data-id="${v.id}" data-type="vehicle">🗑️</button>
                </td>
            `;
            vehicleTable.appendChild(row);
        });
    }

    // DRIVER MANAGEMENT
    const driverTable = document.getElementById('drivers-table');
    function renderDriverTable() {
        driverTable.innerHTML = '';
        db.drivers.forEach(d => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${d.name}</td>
                <td>${d.license}</td>
                <td>${d.health}</td>
                <td>${d.contact}</td>
                <td>${d.assignedBus || 'None'}</td>
                <td class="actions">
                    <button class="edit-btn" data-id="${d.id}" data-type="driver">✏️</button>
                    <button class="delete-btn" data-id="${d.id}" data-type="driver">🗑️</button>
                </td>
            `;
            driverTable.appendChild(row);
        });
    }
    
    // STAFF MANAGEMENT
    const staffTable = document.getElementById('staff-table');
    function renderStaffTable() {
        staffTable.innerHTML = '';
        db.staff.forEach(s => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>STAFF-${String(s.id).padStart(3, '0')}</td>
                <td>${s.name}</td>
                <td>${s.role}</td>
                <td>${s.branch}</td>
                <td>₦${s.salary.toLocaleString()}</td>
                <td class="actions">
                    <button class="edit-btn" data-id="${s.id}" data-type="staff">✏️</button>
                    <button class="delete-btn" data-id="${s.id}" data-type="staff">🗑️</button>
                </td>
            `;
            staffTable.appendChild(row);
        });
    }

    // SETTINGS - PRICES
    const pricesContainer = document.getElementById('prices-container');
    function renderPriceSettings() {
        pricesContainer.innerHTML = '';
        for (const state in db.prices) {
            const div = document.createElement('div');
            div.className = 'form-group';
            div.innerHTML = `
                <label>${state}</label>
                <input type="number" data-state="${state}" value="${db.prices[state]}" class="price-input">
            `;
            pricesContainer.appendChild(div);
        }
    }

    // --- TICKETING LOGIC ---
    const activeTripNotification = document.getElementById('active-trip-notification');
    const ticketPurchaseSection = document.getElementById('ticket-purchase-section');
    function renderActiveTrip() {
        if (db.activeTrip) {
            const { driverName, busPlate, destination, seatsAvailable, totalSeats } = db.activeTrip;
            activeTripNotification.innerHTML = `
                <b>TRIP IN PROGRESS:</b> ${driverName} is driving bus <b>${busPlate}</b> to <b>${destination}</b>.
                <br><b>Seats Remaining: ${seatsAvailable} / ${totalSeats}</b>
            `;
            activeTripNotification.className = seatsAvailable > 0 ? '' : 'no-trip';
            if (seatsAvailable > 0) {
                activeTripNotification.style.backgroundColor = 'var(--success-color)';
            } else {
                 activeTripNotification.innerHTML += '<br><b>BUS IS FULL!</b>';
                 activeTripNotification.style.backgroundColor = 'var(--error-color)';
            }
            
            document.getElementById('ticket-destination-display').value = destination;
            document.getElementById('ticket-price-display').value = db.prices[destination];
            ticketPurchaseSection.classList.remove('hidden');
        } else {
            activeTripNotification.textContent = 'No active trip. Ticketing is currently disabled.';
            activeTripNotification.className = 'no-trip';
            activeTripNotification.style.backgroundColor = 'var(--error-color)';
            ticketPurchaseSection.classList.add('hidden');
        }
    }
    
    // Trip setup form submission
    document.getElementById('trip-setup-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const busPlate = document.getElementById('trip-bus-plate').value;
        const bus = db.vehicles.find(v => v.plate === busPlate);
        
        db.activeTrip = {
            busPlate: busPlate,
            driverName: document.getElementById('trip-driver-name').value,
            driverPhone: document.getElementById('trip-driver-phone').value,
            destination: document.getElementById('trip-destination').value,
            totalSeats: bus.capacity,
            seatsAvailable: bus.capacity
        };
        saveDB();
        renderActiveTrip();
        e.target.reset();
        alert('Trip started successfully! Ticketing is now enabled for this trip.');
    });

    // Ticket purchase form submission
    document.getElementById('ticket-purchase-form').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!db.activeTrip || db.activeTrip.seatsAvailable <= 0) {
            alert('Cannot sell ticket. No seats available or no active trip.');
            return;
        }

        const newTicket = {
            id: Date.now(),
            ticketNo: String(Math.floor(10000 + Math.random() * 90000)),
            passengerName: document.getElementById('passenger-name').value,
            destination: db.activeTrip.destination,
            price: db.prices[db.activeTrip.destination],
            date: new Date().toISOString().split('T')[0],
            busPlate: db.activeTrip.busPlate,
            driverName: db.activeTrip.driverName
        };

        db.tickets.push(newTicket);
        db.activeTrip.seatsAvailable--;
        
        saveDB();
        renderActiveTrip();
        renderDashboardStats();
        
        // Show generated ticket
        const ticketReceipt = document.getElementById('ticket-receipt');
        ticketReceipt.innerHTML = `
            <h3>ADAM & EVE MOTORS - E-TICKET</h3>
            <p><strong>Ticket ID:</strong> <span class="ticket-id">${newTicket.ticketNo}</span></p>
            <p><strong>Passenger:</strong> ${newTicket.passengerName}</p>
            <p><strong>Destination:</strong> ${newTicket.destination}</p>
            <p><strong>Price:</strong> ₦${newTicket.price.toLocaleString()}</p>
            <p><strong>Date:</strong> ${newTicket.date}</p>
            <p><strong>Bus Plate:</strong> ${newTicket.busPlate}</p>
            <p><strong>Driver:</strong> ${newTicket.driverName}</p>
            <hr><p style="text-align:center; font-size: 12px;">Thank you for choosing us!</p>
        `;
        showModal('generated-ticket-modal');
        e.target.reset();
    });


    // --- MODAL & FORM HANDLING ---
    const modals = document.querySelectorAll('.modal');
    function showModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
    function hideModals() { modals.forEach(m => m.classList.add('hidden')); }
    
    modals.forEach(m => {
        m.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal') || e.target.classList.contains('modal-close')) {
                hideModals();
            }
        });
    });

    // Vehicle Modal
    const vehicleModal = document.getElementById('vehicle-modal');
    const vehicleForm = document.getElementById('vehicle-form');
    document.getElementById('add-vehicle-btn').addEventListener('click', () => {
        document.getElementById('vehicle-modal-title').textContent = 'Add New Vehicle';
        vehicleForm.reset();
        document.getElementById('vehicle-id').value = '';
        showModal('vehicle-modal');
    });

    vehicleForm.addEventListener('submit', e => {
        e.preventDefault();
        const id = document.getElementById('vehicle-id').value;
        const vehicleData = {
            plate: document.getElementById('vehicle-plate').value,
            brand: document.getElementById('vehicle-brand').value,
            capacity: parseInt(document.getElementById('vehicle-capacity').value),
            purchaseDate: document.getElementById('vehicle-purchase-date').value,
            insurance: document.getElementById('vehicle-insurance').value,
        };
        if (id) { // Update
            const index = db.vehicles.findIndex(v => v.id == id);
            db.vehicles[index] = { ...db.vehicles[index], ...vehicleData };
        } else { // Create
            vehicleData.id = Date.now();
            db.vehicles.push(vehicleData);
        }
        saveDB();
        renderVehicleTable();
        populateSelects();
        hideModals();
    });

    // Driver Modal
    const driverModal = document.getElementById('driver-modal');
    const driverForm = document.getElementById('driver-form');
    document.getElementById('add-driver-btn').addEventListener('click', () => {
        document.getElementById('driver-modal-title').textContent = 'Add New Driver';
        driverForm.reset();
        document.getElementById('driver-id').value = '';
        showModal('driver-modal');
    });

    driverForm.addEventListener('submit', e => {
        e.preventDefault();
        const id = document.getElementById('driver-id').value;
        const driverData = {
            name: document.getElementById('driver-name').value,
            license: document.getElementById('driver-license').value,
            health: document.getElementById('driver-health').value,
            contact: document.getElementById('driver-contact').value,
            assignedBus: document.getElementById('driver-bus-assignment').value,
        };
        if (id) { // Update
            const index = db.drivers.findIndex(d => d.id == id);
            db.drivers[index] = { ...db.drivers[index], ...driverData };
        } else { // Create
            driverData.id = Date.now();
            db.drivers.push(driverData);
        }
        saveDB();
        renderDriverTable();
        hideModals();
    });
    
    // Staff Modal
    const staffModal = document.getElementById('staff-modal');
    const staffForm = document.getElementById('staff-form');
    document.getElementById('add-staff-btn').addEventListener('click', () => {
        document.getElementById('staff-modal-title').textContent = 'Add New Staff';
        staffForm.reset();
        document.getElementById('staff-id').value = '';
        showModal('staff-modal');
    });
    
    staffForm.addEventListener('submit', e => {
        e.preventDefault();
        const id = document.getElementById('staff-id').value;
        const staffData = {
            name: document.getElementById('staff-name').value,
            role: document.getElementById('staff-role').value,
            branch: document.getElementById('staff-branch').value,
            salary: parseFloat(document.getElementById('staff-salary').value),
        };
        if (id) { // Update
            const index = db.staff.findIndex(s => s.id == id);
            db.staff[index] = { ...db.staff[index], ...staffData };
        } else { // Create
            staffData.id = Date.now();
            db.staff.push(staffData);
        }
        saveDB();
        renderStaffTable();
        hideModals();
    });
    
    // --- EDIT & DELETE (Event Delegation) ---
    document.body.addEventListener('click', e => {
        if (e.target.classList.contains('edit-btn')) {
            const id = e.target.dataset.id;
            const type = e.target.dataset.type;
            
            if(type === 'vehicle') {
                const vehicle = db.vehicles.find(v => v.id == id);
                document.getElementById('vehicle-modal-title').textContent = 'Edit Vehicle';
                document.getElementById('vehicle-id').value = vehicle.id;
                document.getElementById('vehicle-plate').value = vehicle.plate;
                document.getElementById('vehicle-brand').value = vehicle.brand;
                document.getElementById('vehicle-capacity').value = vehicle.capacity;
                document.getElementById('vehicle-purchase-date').value = vehicle.purchaseDate;
                document.getElementById('vehicle-insurance').value = vehicle.insurance;
                showModal('vehicle-modal');
            } else if (type === 'driver') {
                const driver = db.drivers.find(d => d.id == id);
                document.getElementById('driver-modal-title').textContent = 'Edit Driver';
                document.getElementById('driver-id').value = driver.id;
                document.getElementById('driver-name').value = driver.name;
                document.getElementById('driver-license').value = driver.license;
                document.getElementById('driver-health').value = driver.health;
                document.getElementById('driver-contact').value = driver.contact;
                document.getElementById('driver-bus-assignment').value = driver.assignedBus;
                showModal('driver-modal');
            } else if (type === 'staff') {
                const staff = db.staff.find(s => s.id == id);
                document.getElementById('staff-modal-title').textContent = 'Edit Staff';
                document.getElementById('staff-id').value = staff.id;
                document.getElementById('staff-name').value = staff.name;
                document.getElementById('staff-role').value = staff.role;
                document.getElementById('staff-branch').value = staff.branch;
                document.getElementById('staff-salary').value = staff.salary;
                showModal('staff-modal');
            }

        } else if (e.target.classList.contains('delete-btn')) {
            if (!confirm('Are you sure you want to delete this item? This action cannot be undone.')) return;
            
            const id = e.target.dataset.id;
            const type = e.target.dataset.type;

            if (type === 'vehicle') {
                db.vehicles = db.vehicles.filter(v => v.id != id);
                renderVehicleTable();
            } else if (type === 'driver') {
                db.drivers = db.drivers.filter(d => d.id != id);
                renderDriverTable();
            } else if (type === 'staff') {
                db.staff = db.staff.filter(s => s.id != id);
                renderStaffTable();
            }
            saveDB();
            renderAll();
        }
    });
    
    // --- SETTINGS FORM ---
    document.getElementById('prices-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const priceInputs = document.querySelectorAll('.price-input');
        priceInputs.forEach(input => {
            const state = input.dataset.state;
            const price = parseFloat(input.value);
            if (!isNaN(price)) {
                db.prices[state] = price;
            }
        });
        saveDB();
        alert('Prices updated successfully!');
        renderActiveTrip(); // To update price if a trip is active
    });

    // --- UTILITY FUNCTIONS ---
    function populateSelects() {
        const busSelects = [
            document.getElementById('driver-bus-assignment'),
            document.getElementById('trip-bus-plate')
        ];
        const destinationSelect = document.getElementById('trip-destination');

        busSelects.forEach(select => {
            select.innerHTML = '<option value="">None</option>';
            db.vehicles.forEach(v => {
                select.innerHTML += `<option value="${v.plate}">${v.plate} (${v.brand})</option>`;
            });
        });
        
        destinationSelect.innerHTML = '';
        NIGERIAN_STATES.forEach(state => {
            destinationSelect.innerHTML += `<option value="${state}">${state}</option>`;
        });
    }

    // --- INITIALIZATION ---
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(e.target.dataset.section);
        });
    });

    menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('open');
    });

    initializeDB();
    // Initially, only login is shown, so no renderAll() here.
    // It's called after successful login or public access.
});
</script>

</body>
</html>